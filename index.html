<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ready4Exam Table Automation</title>
  <script type="module" src="./supabaseClient.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
    }
    header {
      background: #1e293b;
      color: white;
      padding: 1rem 2rem;
    }
    main {
      padding: 2rem;
      max-width: 800px;
      margin: auto;
    }
    select, button {
      padding: 10px;
      font-size: 16px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 100%;
    }
    .log {
      background: #f1f5f9;
      border-radius: 10px;
      padding: 15px;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 1rem;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <header>
    <h2>üìò Ready4Exam Table Automation</h2>
  </header>

  <main>
    <label for="classSelect">Select Class:</label>
    <select id="classSelect">
      <option value="">-- Select Class --</option>
      <option>6</option>
      <option>7</option>
      <option>8</option>
      <option>9</option>
      <option>10</option>
    </select>

    <div class="log" id="log"></div>
  </main>

  <script type="module">
    import { supabase } from "./supabaseClient.js";

    const logBox = document.getElementById("log");
    const classSelect = document.getElementById("classSelect");

    const log = (msg) => {
      console.log(msg);
      logBox.textContent += msg + "\n";
      logBox.scrollTop = logBox.scrollHeight;
    };

    classSelect.addEventListener("change", async (e) => {
      const selectedClass = e.target.value;
      if (!selectedClass) return;

      log(`üîç Fetching NCERT subjects for Class ${selectedClass}...`);

      const subjects = await askPerplexity(
        `List all NCERT subjects for Class ${selectedClass} in JSON array format, e.g. ["Science","Mathematics","Social Science","English"].`
      );
      if (!Array.isArray(subjects)) {
        log(`‚ùå Invalid subject response: ${JSON.stringify(subjects)}`);
        return;
      }
      log(`‚úÖ Loaded ${subjects.length} subjects.`);

      for (const subject of subjects) {
        log(`üîç Fetching NCERT chapters for ${subject} (Class ${selectedClass})...`);
        const chapters = await askPerplexity(
          `List all NCERT chapter names for Class ${selectedClass} ${subject} as a clean JSON array.`
        );

        if (!Array.isArray(chapters)) {
          log(`‚ö†Ô∏è Skipping invalid chapter response for ${subject}.`);
          continue;
        }
        log(`‚úÖ Loaded ${chapters.length} chapters.`);

        for (const chapter of chapters) {
          const tableName = chapter
            .toLowerCase()
            .replace(/[^a-z0-9_]+/g, "_")
            .replace(/^_+|_+$/g, "");

          log(`üöÄ Generating quiz questions for "${chapter}"...`);

          const questions = await askPerplexity(
            `Generate 5 NCERT-style MCQ questions for Class ${selectedClass} ${subject}, Chapter "${chapter}". 
             Each should include: difficulty, question_type, question_text, scenario_reason_text (if any), options A-D, and correct_answer_key. 
             Return pure JSON array of objects.`
          );

          if (!Array.isArray(questions)) {
            log(`‚ö†Ô∏è Invalid question format for ${chapter}. Skipping.`);
            continue;
          }

          // Ensure table exists
          const { error: tableErr } = await supabase.rpc("create_table_if_not_exists", {
            table_name: tableName,
          });
          if (tableErr) {
            log(`‚ùå Table creation failed for ${tableName}: ${tableErr.message}`);
            continue;
          }

          log(`üì• Inserting ${questions.length} questions into table "${tableName}"...`);
          const { error: insertErr } = await supabase.from(tableName).insert(questions);

          if (insertErr) {
            log(`‚ùå Insert failed for ${tableName}: ${insertErr.message}`);
          } else {
            log(`‚úÖ Inserted successfully into "${tableName}".`);
          }
        }
      }

      log(`üéâ All subjects processed for Class ${selectedClass}.`);
    });

    // -----------------
    // Perplexity helper
    // -----------------
    async function askPerplexity(prompt) {
      log("üß† Asking Perplexity...");
      try {
        const res = await fetch("https://tableautomation.vercel.app/api/perplexity", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt }),
        });

        if (!res.ok) throw new Error(`Perplexity request failed (${res.status})`);

        const data = await res.json();

        // Try extracting model reply
        const reply =
          data?.choices?.[0]?.message?.content ||
          data?.raw ||
          JSON.stringify(data);

        try {
          return JSON.parse(reply);
        } catch {
          return reply;
        }
      } catch (err) {
        log(`‚ùå Error: ${err.message}`);
        return null;
      }
    }
  </script>
</body>
</html>
