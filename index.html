<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Automation Tool - Ready4Exam</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #f8fafc;
      color: #111;
      margin: 0;
      padding: 2rem;
    }
    h1 {
      text-align: center;
      color: #2563eb;
    }
    select, textarea, button {
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
    }
    textarea {
      height: 150px;
      resize: vertical;
    }
    #log {
      white-space: pre-wrap;
      background: #111;
      color: #0f0;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      height: 200px;
      overflow-y: auto;
    }
    button {
      background: #2563eb;
      color: #fff;
      cursor: pointer;
      border: none;
      font-size: 16px;
      border-radius: 8px;
      padding: 10px 20px;
    }
    button:hover {
      background: #1d4ed8;
    }
  </style>
</head>
<body>
  <h1>üìò Ready4Exam Automation Tool</h1>

  <label>Select Class:</label>
  <select id="classSelect">
    <option value="">-- Select Class --</option>
    <option>5</option>
    <option>6</option>
    <option>7</option>
    <option>8</option>
    <option>9</option>
    <option>10</option>
    <option>11</option>
    <option>12</option>
  </select>

  <label>Select Subject:</label>
  <select id="subjectSelect"></select>

  <label>Select Chapter:</label>
  <select id="chapterSelect"></select>

  <button id="generateBtn">üöÄ Generate Questions & Upload</button>

  <h3>Logs:</h3>
  <pre id="log"></pre>

  <script>
    const SUPABASE_URL = "https://gkyvojcmqsgdynmitcuf.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdreXZvamNtcXNnZHlubWl0Y3VmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NDQ0OTcsImV4cCI6MjA3NjMyMDQ5N30.5dn5HbXxQ5sYNECS9o3VxVeyL6I6Z2Yf-nmPwztx1hE";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const PPLX_PROXY = "https://tableautomation.vercel.app/api/perplexity";

    const logEl = document.getElementById("log");
    const log = (msg) => {
      console.log(msg);
      logEl.textContent += msg + "\n";
    };

    const classSelect = document.getElementById("classSelect");
    const subjectSelect = document.getElementById("subjectSelect");
    const chapterSelect = document.getElementById("chapterSelect");

    classSelect.addEventListener("change", async () => {
      const selectedClass = classSelect.value;
      subjectSelect.innerHTML = "";
      chapterSelect.innerHTML = "";
      if (!selectedClass) return;

      log(`üîç Fetching NCERT subjects for Class ${selectedClass}...`);

      const prompt = `List all NCERT subjects for Class ${selectedClass} as a JSON array. Example: ["Science", "Mathematics", "Social Science"].`;

      const response = await askPerplexity(prompt);
      try {
        const subjects = JSON.parse(response);
        subjectSelect.innerHTML = `<option value="">-- Select Subject --</option>`;
        subjects.forEach((subj) => {
          subjectSelect.innerHTML += `<option value="${subj}">${subj}</option>`;
        });
        log(`‚úÖ Found ${subjects.length} subjects for Class ${selectedClass}.`);
      } catch (err) {
        log(`‚ùå Failed to parse subjects: ${err.message}`);
      }
    });

    subjectSelect.addEventListener("change", async () => {
      const selectedClass = classSelect.value;
      const selectedSubject = subjectSelect.value;
      chapterSelect.innerHTML = "";
      if (!selectedSubject) return;

      log(`üìö Fetching chapters for ${selectedSubject}, Class ${selectedClass}...`);

      const prompt = `List all chapters in the NCERT ${selectedSubject} textbook for Class ${selectedClass} as a JSON array.`;

      const response = await askPerplexity(prompt);
      try {
        const chapters = JSON.parse(response);
        chapterSelect.innerHTML = `<option value="">-- Select Chapter --</option>`;
        chapters.forEach((ch) => {
          chapterSelect.innerHTML += `<option value="${ch}">${ch}</option>`;
        });
        log(`‚úÖ Found ${chapters.length} chapters for ${selectedSubject}.`);
      } catch (err) {
        log(`‚ùå Failed to parse chapters: ${err.message}`);
      }
    });

    document.getElementById("generateBtn").addEventListener("click", async () => {
      const cls = classSelect.value;
      const subject = subjectSelect.value;
      const chapter = chapterSelect.value;

      if (!cls || !subject || !chapter)
        return alert("Please select class, subject, and chapter first.");

      const tableName = formatTableName(chapter);
      log(`üß† Creating Supabase table: ${tableName}...`);

      const { error: tableErr } = await createTableIfNotExists(tableName);
      if (tableErr) {
        log(`‚ùå Failed to create table: ${tableErr.message}`);
        return;
      }

      log(`‚úÖ Table "${tableName}" ready. Generating quiz questions...`);

      const prompt = `
Generate exactly 60 unique quiz questions from the NCERT Class ${cls}, Subject: ${subject}, Chapter: "${chapter}".
Format output strictly as CSV with these columns:
difficulty,question_type,question_text,scenario_reason_text,option_a,option_b,option_c,option_d,correct_answer_key
Follow these rules:
- Simple: 20 questions (10 MCQ, 5 AR, 5 Case-Based)
- Medium: 20 questions (10 MCQ, 5 AR, 5 Case-Based)
- Advanced: 20 questions (10 MCQ, 5 AR, 5 Case-Based)
Return only CSV data, no extra text.`;

      const csvText = await askPerplexity(prompt);
      log(`‚úÖ Questions generated. Uploading to Supabase...`);

      const rows = parseCSV(csvText);
      const { error: insertErr } = await supabase.from(tableName).insert(rows);
      if (insertErr) {
        log(`‚ùå Upload failed: ${insertErr.message}`);
        return;
      }
      log(`üéâ Successfully inserted ${rows.length} questions into "${tableName}".`);
    });

    async function askPerplexity(prompt) {
      log(`üß† Asking Perplexity...`);
      const r = await fetch(PPLX_PROXY, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt }),
      });
      if (!r.ok) throw new Error("Failed to fetch from Perplexity proxy");
      return await r.text();
    }

    function formatTableName(chapter) {
      const words = chapter.trim().split(/\s+/);
      return words.length > 1
        ? `${words[0].toLowerCase()}_${words[1].toLowerCase()}`
        : words[0].toLowerCase();
    }

    async function createTableIfNotExists(tableName) {
      const ddl = `
      CREATE TABLE IF NOT EXISTS ${tableName} (
        id SERIAL PRIMARY KEY,
        difficulty TEXT,
        question_type TEXT,
        question_text TEXT,
        scenario_reason_text TEXT,
        option_a TEXT,
        option_b TEXT,
        option_c TEXT,
        option_d TEXT,
        correct_answer_key TEXT
      );`;
      try {
        const { error } = await supabase.rpc("exec_sql", { sql: ddl });
        return { error };
      } catch (err) {
        return { error: err };
      }
    }

    function parseCSV(csvText) {
      csvText = csvText.replace(/^\uFEFF/, "").trim();
      const lines = csvText.split("\n").filter(l => l.trim());
      const header = lines[0].split(",").map(h => h.trim());
      const rows = lines.slice(1).map(line => {
        const values = line.split(",").map(v => v.trim().replace(/^"|"$/g, ""));
        const obj = {};
        header.forEach((h, i) => (obj[h] = values[i] || ""));
        return obj;
      });
      return rows;
    }
  </script>
</body>
</html>
