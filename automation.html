<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ready4Exam Automation</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 700px; margin: auto; padding: 2rem; }
    select, button, textarea { width: 100%; margin: 1rem 0; padding: 0.6rem; font-size: 1rem; }
    pre { background: #f4f4f4; padding: 1rem; border-radius: 8px; height: 200px; overflow: auto; }
  </style>
</head>
<body>

  <h2>ğŸ“˜ NCERT Quiz Generator (via Perplexity)</h2>
  <label>Class:</label>
  <select id="classSelect">
    <option value="">Select Class</option>
    <option>5</option><option>6</option><option>7</option><option>8</option>
    <option>9</option><option>10</option><option>11</option><option>12</option>
  </select>

  <label>Subject:</label>
  <select id="subjectSelect" disabled><option value="">Select Subject</option></select>

  <label>Chapter:</label>
  <select id="chapterSelect" disabled><option value="">Select Chapter</option></select>

  <button id="generateBtn" disabled>ğŸš€ Generate Quiz & Upload</button>

  <h3>Logs:</h3>
  <pre id="log"></pre>

  <script>
    // --- Supabase Setup ---
    const SUPABASE_URL = "https://gkyvojcmqsgdynmitcuf.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdreXZvamNtcXNnZHlubWl0Y3VmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NDQ0OTcsImV4cCI6MjA3NjMyMDQ5N30.5dn5HbXxQ5sYNECS9o3VxVeyL6I6Z2Yf-nmPwztx1hE";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const logEl = document.getElementById('log');
    const log = (msg) => logEl.textContent += msg + "\n";

    const perplexityKey = "YOUR_PERPLEXITY_API_KEY"; // ğŸ”‘ Add your API key here
    const baseUrl = "https://api.perplexity.ai/chat/completions";

    async function fetchPerplexity(prompt) {
      const res = await fetch(baseUrl, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${perplexityKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: "llama-3.1-sonar-large-128k-online",
          messages: [{ role: "user", content: prompt }]
        })
      });
      const data = await res.json();
      return data.choices?.[0]?.message?.content || "";
    }

    const classSel = document.getElementById("classSelect");
    const subjectSel = document.getElementById("subjectSelect");
    const chapterSel = document.getElementById("chapterSelect");
    const generateBtn = document.getElementById("generateBtn");

    classSel.addEventListener("change", async () => {
      const cls = classSel.value;
      if (!cls) return;
      subjectSel.disabled = true;
      chapterSel.disabled = true;
      log(`ğŸ” Fetching subjects for Class ${cls}...`);
      const response = await fetchPerplexity(`List all NCERT subjects taught in Class ${cls}. Respond in JSON format as {"subjects": ["Science", "Maths", ...]}`);
      try {
        const data = JSON.parse(response);
        subjectSel.innerHTML = "<option value=''>Select Subject</option>";
        data.subjects.forEach(sub => {
          const opt = document.createElement("option");
          opt.value = sub;
          opt.textContent = sub;
          subjectSel.appendChild(opt);
        });
        subjectSel.disabled = false;
      } catch {
        log("âŒ Failed to parse subjects.");
      }
    });

    subjectSel.addEventListener("change", async () => {
      const cls = classSel.value;
      const subject = subjectSel.value;
      chapterSel.disabled = true;
      log(`ğŸ“š Fetching chapters for ${subject} (Class ${cls})...`);
      const response = await fetchPerplexity(`List all NCERT chapter titles for Class ${cls} ${subject}. Respond in JSON format as {"chapters": ["Chapter 1 - ...", ...]}`);
      try {
        const data = JSON.parse(response);
        chapterSel.innerHTML = "<option value=''>Select Chapter</option>";
        data.chapters.forEach(ch => {
          const opt = document.createElement("option");
          opt.value = ch;
          opt.textContent = ch;
          chapterSel.appendChild(opt);
        });
        chapterSel.disabled = false;
      } catch {
        log("âŒ Failed to parse chapters.");
      }
    });

    generateBtn.addEventListener("click", async () => {
      const chapter = chapterSel.value;
      if (!chapter) return;
      const tableName = chapter.toLowerCase().replace(/\s+/g, '_').replace(/[^\w_]/g, '');
      log(`ğŸ§¾ Creating table "${tableName}" and generating quiz...`);
      
      const prompt = `
Generate exactly 60 unique quiz questions from NCERT chapter "${chapter}".
Follow this schema and output ONLY CSV:

difficulty,question_type,question_text,scenario_reason_text,option_a,option_b,option_c,option_d,correct_answer_key

Apply these distribution rules:
Simple: 20 (10 MCQ, 5 AR, 5 Case-Based)
Medium: 20 (10 MCQ, 5 AR, 5 Case-Based)
Advanced: 20 (10 MCQ, 5 AR, 5 Case-Based)
`;

      const csv = await fetchPerplexity(prompt);
      log("âœ… CSV generated. Uploading to Supabase...");

      const lines = csv.trim().split("\n");
      const headers = lines[0].split(",");
      const rows = lines.slice(1).map(line => {
        const values = line.split(",");
        const obj = {};
        headers.forEach((h, i) => obj[h.trim()] = values[i]?.trim() || "");
        return obj;
      });

      const { error } = await supabase.from(tableName).insert(rows);
      if (error) {
        log("âŒ Supabase error: " + error.message);
      } else {
        log(`ğŸ‰ Table "${tableName}" created and populated with ${rows.length} rows.`);
      }
    });

    chapterSel.addEventListener("change", () => generateBtn.disabled = !chapterSel.value);
  </script>
</body>
</html>
